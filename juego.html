<html>
<head>
	
	<title>Wolf Attack</title>
	<style type="text/css">
		.flex-container{
		 display: flex;
		}

		.flex-child{
			flex: 1;
			border: 2px solid yellow;
		}

		.mPausa {
            width: 50vw;
            height: 55vh;
            background-image: url(CSS/menus.png);
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 100;
            position: fixed;
            top: 10vh;
            left: 25vw;
            visibility: hidden;
			border-radius:10px ;
			border-width: 3px;
			border-color: rgb(238, 151, 20);
        }
		.imgWin{
			width: 50vw;
            height: 55vh;
            background-image: url(CSS/menusWin.png);
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
			z-index: 100;
			position:fixed;
			top: 10vh;
            left: 0%;
			color: rgb(67, 67, 158);
			font-weight: bolder;
    		font-family: 'Akaya Kanadaka', cursive;
            visibility: hidden;
		}
		.imgLose{
			width: 50vw;
            height: 55vh;
            background-image: url(CSS/menusLose.png);
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
			z-index: 100;
			position:fixed;
			top: 10vh;
            right: 0%;
			color: rgb(163, 19, 26);
            font-weight: bolder;
    		font-family: 'Akaya Kanadaka', cursive;
			visibility: hidden;
		}
		
		

	</style>
	<script type="text/javascript" src="js/jquery-3.5.1.min.js"></script> 
	<script type="text/javascript" src="js/libs/three/three2.js"></script> 
	<script type="text/javascript" src="js/libs/three/MTLLoader.js"></script> 
	<script type="text/javascript" src="js/libs/three/FBXLoader.js"></script> 
	<script type="text/javascript" src="js/libs/three/OBJLoader.js"></script>
	<script type="text/javascript" src="js/libs/three/inflate.min.js"></script>  
	<script type="text/javascript" src ="js/THREE.GamepadControls.js"></script>
	<script type="text/javascript" src ="js/Controles.js"></script>
	<link rel="stylesheet" href="CSS/pausa.css">
	<script type="text/javascript">

			

			function MovimientosJugador( camara,  objeto,  foward, yaw, lados,subir,jugador) {

				let vector = new THREE.Vector3();
				
				
			
				camara.getWorldDirection( vector );

				objeto.position.x += vector.x * foward * deltaTime;
				objeto.position.z += vector.z * foward * deltaTime;


				jugador.position.x += vector.x * foward * deltaTime;
				jugador.position.z += vector.z * foward * deltaTime;


				jugador.getWorldDirection( vector );


				objeto.translateX(lados*deltaTime);

				jugador.translateX(-lados*deltaTime);	


			

				camara.getWorldDirection( vector );



			const myAxis = new THREE.Vector3(0,1, 0);

			objeto.rotateOnAxis(myAxis, yaw * deltaTime);
			jugador.rotateOnAxis(myAxis, yaw * deltaTime);


			var myAxis2 = new THREE.Vector3(0,0, 1);

				
				camara.rotateX(subir * deltaTime);
				//objeto.rotateOnAxis(myAxis2,-subir * deltaTime);
				camara.getWorldDirection( vector );
				if(vector.y < -0.5 || vector.y >0.5){
				camara.rotateX(-subir * deltaTime);
				//objeto.rotateOnAxis(myAxis2,subir * deltaTime);
			}

			


}
	var scene;
	var camera;
	var camera2;
	var renderer;
	var renderer2;
	var controls;
	var objs= [];
	var objects = [];
	var clock;
	var deltaTime;	
	var keys = {};
	var rayCaster;
	var isWorldReady = [ false, false,false ,false,false,false,false,false,false,false];
	var pausa = false;
	var mixers = [];
	var mixers_2 = [];
	var persona;
	
	
	$(document).ready(function() {

		function getQueryVariable(variable) {
        	var query = window.location.search.substring(1);
        	var vars = query.split("&");
        	for (var i = 0; i < vars.length; i++) {
        	    var pair = vars[i].split("=");
        	    if (pair[0] == variable) {
        	        return pair[1];
        	    }
        	}
        	return false;
    	}
		$(".btn-Retornar").click(function () {
                $(".mPausa").css("visibility", "hidden");
                pauseGame = false;
        });

        $(".btn-Menu").click(function () { 
            setTimeout(function () {
                window.location.href = "index.html";
            }, 1000);
        });
		setupScene();
		rayCaster = new THREE.Raycaster();


		var loader = new THREE.FBXLoader();
		loadOBJWithMTL("models/nuevosModelos/", "pollito.obj", "pollito.mtl", (object) => {
			


		object.rotation.y = THREE.Math.degToRad(180);
		object.scale.set(.1,.1,.1);
	

		
		var ancla = new THREE.Object3D();
			ancla.position.x=0;
			ancla.position.z=0;
			ancla.position.y=0;

			ancla.name="jugador1";
			object.name = "pollito";
			//object.position.z=-10;
			ancla.add(camera);
			ancla.camera;
			camera.position.z=5;
			camera.position.y=5;
			//camera.rotation.y= THREE.Math.degToRad(180);
			scene.add(object);
			scene.add(ancla);

			var material2 = new THREE.MeshLambertMaterial({
			color: new THREE.Color(0.0,0.0,0.5)
		});

			isWorldReady[6] = true;;
			console.log("cargar pollito normal terminado 6 ");




		});

	
	
		camera.misRayos = [
			new THREE.Vector3(0,0,1),
			new THREE.Vector3(0,0,-1),
			new THREE.Vector3(1,0,0),
			new THREE.Vector3(-1,0,0),
			new THREE.Vector3(0,-1,0)
		];
		
		

			var material2 = new THREE.MeshLambertMaterial({
			color: new THREE.Color(0.0,0.0,0.5)
		});


			var geometry2 = new THREE.BoxGeometry(1,1,1);
			var ancla2 = new THREE.Object3D();
			var cubo2  = new THREE.Mesh(geometry2,material2);
			ancla2.name="jugador2";
			cubo2.scale.set(5,5,5);
			cubo2.position.z=-10;
			ancla2.add(cubo2);
			scene.add(ancla2);
			
		loadOBJWithMTL("assets/", "box.obj", "box.mtl", (object) => {
			object.position.z = -30;			

	
			
			
			console.log("boxx cargado 0");
			isWorldReady[0] = true;
		});

	

		loadOBJWithMTL("models/nuevosModelos/", "dianaGrande.obj", "dianaGrande.mtl", (object) => {
			object.position.z = -10;
			//object.rotation.x = THREE.Math.degToRad(-90);
			object.scale.set(.1,.1,.1);

			scene.add(object);
			console.log("Diana grande cargado 1");
			isWorldReady[1] = true;
		});

		loadOBJWithMTL("models/nuevosModelos/", "dianaSobrePalito.obj", "dianaSobrePalito.mtl", (object) => {
			object.position.z = -30;
			//object.rotation.x = THREE.Math.degToRad(-90);
			object.position.x=30;
			object.scale.set(.1,.1,.1);

			scene.add(object);
			console.log("Diana sobre Palito cargado 2");
			isWorldReady[2] = true;
		});

		loadOBJWithMTL("models/nuevosModelos/", "dianaSolitaCuerdita.obj", "dianaSolitaCuerdita.mtl", (object) => {
			object.position.z = -30;
			//object.rotation.x = THREE.Math.degToRad(-90);
			object.position.x=-30;
			object.position.y=5;
			object.scale.set(.1,.1,.1);

			scene.add(object);
			console.log("diana solita cuerdita cargado 3");
			isWorldReady[3] = true;
		});

		loadOBJWithMTL("models/nuevosModelos/", "dianaSolitaGancho.obj", "dianaSolitaGancho.mtl", (object) => {
			object.position.z = -30;
			//object.rotation.x = THREE.Math.degToRad(-90);
			object.position.x=0;
			object.position.y=5;
			object.scale.set(.1,.1,.1);

			scene.add(object);
			console.log("diana solita gancho cargado 4"); 
			isWorldReady[4] = true;
		});

		loadOBJWithMTL("models/nuevosModelos/", "dianaSolitaGancho.obj", "dianaSolitaGancho.mtl", (object) => {
			object.position.z = 0;
			//object.rotation.x = THREE.Math.degToRad(-90);
			object.position.x=30;
			object.position.y=0;
			object.scale.set(.1,.1,.1);

			scene.add(object);
			isWorldReady[5] = true;
			console.log("diana solita gancho x2 cargado 5");
		});
		loadOBJWithMTL("models/nuevosModelos/", "lobo.obj", "lobo.mtl", (object) => {
			object.position.z = -15;
			//object.rotation.x = THREE.Math.degToRad(-90);
			object.position.x=15;
			object.position.y=0;
			object.scale.set(.1,.1,.1);

			scene.add(object);
			console.log("lobo cargado 7");
			isWorldReady[7] = true;
		});

		loadOBJWithMTL("models/nuevosModelos/", "pollito.obj", "pollito.mtl", (object) => {
			object.position.z = -15;
			//object.rotation.x = THREE.Math.degToRad(-90);
			object.position.x=0;
			object.position.y=0;
			object.scale.set(.01,.01,.01);

			scene.add(object);
			console.log("pollo cargado 8");
			isWorldReady[8] = true;
		});

	/*	loadOBJWithMTL("models/nuevosModelos/", "pollito.obj", "pollito.mtl", (object) => {
			object.position.z = -15;
			//object.rotation.x = THREE.Math.degToRad(-90);
			object.position.x=-15;
			object.position.y=0;
			object.scale.set(.1,.1,.1);
			scene.add(object);
			isWorldReady[6] = true;
		});*/

			var idEsc=getQueryVariable("id");
	if(idEsc==1){
		loadOBJWithMTL("models/terrenoPlano/", "terreno1.obj", "terreno1.mtl", (object) => {
			object.position.z = -0;
			//object.rotation.x = THREE.Math.degToRad(-90);
			object.position.x=0;
			object.position.y=-10;
			object.scale.set(.2,.2,.2);
			scene.add(object);
			console.log("el escenario completo cargado 9");
			objects.push(object);
			isWorldReady[9] = true;
		});
		loadOBJWithMTL("models/terrenoPlano/", "awaTerreno1.obj", "awaTerreno1.mtl", (object) => {
			object.position.z = -0;
			//object.rotation.x = THREE.Math.degToRad(-90);
			object.position.x=0;
			object.position.y=-10;
			object.scale.set(.2,.2,.2);
			scene.add(object);
			console.log("el escenario completo cargado 9");
			objects.push(object);
			isWorldReady[9] = true;
		});
		loadOBJWithMTL("models/elementosTerrenoPlano/", "elementosTerreno1.obj", "elementosTerreno1.mtl", (object) => {
			object.position.z = -0;
			//object.rotation.x = THREE.Math.degToRad(-90);
			object.position.x=0;
			object.position.y=-13;
			object.scale.set(.2,.2,.2);
			scene.add(object);
			console.log("el escenario completo cargado 9");
			objects.push(object);
			isWorldReady[9] = true;
		});
	}else{
		if(idEsc==2){
			loadOBJWithMTL("models/terrenoPlano/", "terreno2.obj", "terreno2.mtl", (object) => {
				object.position.z = -0;
				//object.rotation.x = THREE.Math.degToRad(-90);
				object.position.x=0;
				object.position.y=-1;
				object.scale.set(.2,.2,.2);
				scene.add(object);
				console.log("el escenario completo cargado 9");
				objects.push(object);
				isWorldReady[9] = true;
			});
			loadOBJWithMTL("models/elementosTerrenoPlano/", "elementosTerreno2.obj", "elementosTerreno2.mtl", (object) => {
				object.position.z = -0;
				//object.rotation.x = THREE.Math.degToRad(-90);
				object.position.x=0;
				object.position.y=-1;
				object.scale.set(.2,.2,.2);
				scene.add(object);
				console.log("el escenario completo cargado 9");
				objects.push(object);
				isWorldReady[9] = true;
			});
		}else{
			if(idEsc==3){
				loadOBJWithMTL("models/terrenoPlano/", "terreno3.obj", "terreno3.mtl", (object) => {
					object.position.z = -200;
					//object.rotation.x = THREE.Math.degToRad(-90);
					object.position.x=0;
					object.position.y=-1;
					object.scale.set(5,5,5);
					scene.add(object);
					console.log("el escenario completo cargado 9");
					objects.push(object);
					isWorldReady[9] = true;
				});
				loadOBJWithMTL("models/terrenoPlano/", "awaTerreno3.obj", "awaTerreno3.mtl", (object) => {
					object.position.z = -200;
					//object.rotation.x = THREE.Math.degToRad(-90);
					object.position.x=0;
					object.position.y=-1;
					object.scale.set(5,5,5);
					scene.add(object);
					console.log("el escenario completo cargado 9");
					objects.push(object);
					isWorldReady[9] = true;
				});
				loadOBJWithMTL("models/elementosTerrenoPlano/", "elementosTerreno3.obj", "elementosTerreno3.mtl", (object) => {
					object.position.z = -200;
					//object.rotation.x = THREE.Math.degToRad(-90);
					object.position.x=0;
					object.position.y=-1;
					object.scale.set(5,5,5);
					scene.add(object);
					console.log("el escenario completo cargado 9");
					objects.push(object);
					isWorldReady[9] = true;
				});
			}
		}
	}
		render();

		document.addEventListener('keydown', onKeyDown);
		document.addEventListener('keyup', onKeyUp);		
	});

	function loadOBJWithMTL(path, objFile, mtlFile, onLoadCallback) {
		var mtlLoader = new THREE.MTLLoader();
		mtlLoader.setPath(path);
		mtlLoader.load(mtlFile, (materials) => {
			
			var objLoader = new THREE.OBJLoader();
			objLoader.setMaterials(materials);
			objLoader.setPath(path);
			objLoader.load(objFile, (object) => {
				onLoadCallback(object);
			});

		});
	}

	window.addEventListener("gamepadconnected", function (e) {
                var gp = navigator.getGamepads()[e.gamepad.index];
                console.log("Gamepad connected at index " + gp.index + ": " + gp.id + ". It has " + gp.buttons.length + " buttons and " + gp.axes.length + " axes.");
            });

            window.addEventListener("gamepaddisconnected", function () {
                console.log("Waiting for gamepad.");
            });
	function onKeyDown(event) {
		keys[String.fromCharCode(event.keyCode)] = true;
	}
	function onKeyUp(event) {
		keys[String.fromCharCode(event.keyCode)] = false;
	}

	
	function render() {
		 const gamepads = navigator.getGamepads();
            if (gamepads[0]) {
                const gamepadState = {
                    id: gamepads[0].id,
                    axes: [
                        gamepads[0].axes[0].toFixed(2),
                        gamepads[0].axes[1].toFixed(2),
                        gamepads[0].axes[2].toFixed(2),
                        gamepads[0].axes[3].toFixed(2),
                    ],
                    buttons: [
                        { buttons_0: gamepads[0].buttons[12].pressed },
                        { buttons_0: gamepads[0].buttons[13].pressed },
                        { buttons_0: gamepads[0].buttons[14].pressed },
                        { buttons_0: gamepads[0].buttons[15].pressed },
                        { buttons_0: gamepads[0].buttons[9].pressed },
                        { buttons_0: gamepads[0].buttons[8].pressed },//start
                    ],
                }
            }

		requestAnimationFrame(render);

		deltaTime = clock.getDelta();	
		var jugador1 = scene.getObjectByName("jugador1");
		var pollito = scene.getObjectByName("pollito");
		var cubo2 = scene.getObjectByName("jugador2");

		var yaw = 0;
		var forward = 0;
		var subir=0;
		var lados = 0;
		
		var yaw2 = 0;
		var forward2 = 0;
		
		if(gamepads[0] != null){
			

  			if(gamepads[0].axes[0] >.9){

  				lados = -20;
  			}


  			if(gamepads[0].axes[0] <-.9){

  				lados = 20;  //derecha derecha +, izquierda -
  			}


  			if(gamepads[0].axes[3] >.9){

  				 subir = -3;// izquierda abajo +, arriba -
  				
  			}

  			if(gamepads[0].axes[3] <-.9){

  				subir = 3; // izquierda abajo +, arriba -
  				
  			}

  			if(gamepads[0].axes[2] >.9){

  			yaw = -5;//izqueirda derecha +, izquierda -
  			}

  			if(gamepads[0].axes[2] <-.9){

  				yaw = 5;
  			}


  			if(gamepads[0].axes[1] >.9){

  				forward = -20;// derecha abajo +, arriba -
  			}

  			if(gamepads[0].axes[1] <-.9){

  				forward = 20;// derecha abajo +, arriba -
  			}

  			if(gamepads[0].buttons[7].pressed){//gatillo derecho

  				alert("disparo");
  			}
  		if (gamepads[0].buttons[9].pressed) {
  			
  			if(pausa)
			{
				pausa=false;
				$(".mPausa").css("visibility", "hidden");
			}
			else
			{
				pausa =true;
				$(".mPausa").css("visibility", "visible");
			}
		
			keys["P"] = false;
  		}};

		if (keys["P"]) {
			if(pausa  )
			{
				pausa=false;
				$(".mPausa").css("visibility", "hidden");
			}
			else
			{
				pausa =true;
				$(".mPausa").css("visibility", "visible");
			}
			
			keys["P"] = false;

		}

		if (keys["A"]) {

		let vector = new THREE.Vector3();
			camera.getWorldDirection( vector );

			alert("X  = " + vector.x +  "   Y  = " + vector.y +"  Z  = " + vector.z);

			keys["A"]=false;
		} else if (keys["D"]) {
			alert("RX  = " + camera.rotation.x +  "   RY  = " + camera.rotation.y +"  RZ  = " + camera.rotation.z);
			keys["D"]=false;
		}
		if (keys["W"]) {
			let vector = new THREE.Vector3();

            camera.getWorldPosition ( vector );
		alert("pX  = " + vector.x +  "  pY  = " + vector.y +"  pZ  = " + vector.z);
		keys["W"]=false;
		} else if (keys["S"]) {
		//	forward = 20;
		}

	
		if (keys["J"]) {
			yaw2 = 5;
		} else if (keys["L"]) {
			yaw2 = -5;
		}
		if (keys["I"]) {
			forward2 = -20;
		} else if (keys["K"]) {
			forward2 = 20;
		}



		if (isWorldReady[0] && isWorldReady[1] && isWorldReady[2]
		&& isWorldReady[3] && isWorldReady[4] && isWorldReady[5]
		&& isWorldReady[6] && isWorldReady[7] && isWorldReady[8]
		&& isWorldReady[9] && !pausa) {

		
			/*MovimientosJugador( camara,  objeto,  foward, yaw, lados,subir)*/


			MovimientosJugador( camera,  pollito,  forward, yaw, lados,subir,jugador1);
			
		


			camera2.rotation.y += yaw2 * deltaTime;
			camera2.translateZ(forward2 * deltaTime);

			cubo2.rotation.y += yaw2 * deltaTime;
			cubo2.translateZ(forward2 * deltaTime);

			for(var i = 0;i<camera.misRayos.length;i++){

				var rayo =camera.misRayos[i];

				rayCaster.set(camera.position,rayo);

				var colisiones = rayCaster.intersectObjects(objects,true); // modelos y si sus hijos cuentan o no

			}
			
			console.log(colisiones.length);
			if(colisiones.length > 0){
			
				if (colisiones[0].distance < 1) {
					
					camera.translateZ-(forward * deltaTime);
				}

			}
			//objs.forEach(({mixer}) => {mixer.update(clock.getDelta());});
		}
		
		renderer.render(scene, camera);
		renderer2.render(scene, camera2);
	}

	function setupScene() {		
		var visibleSize = { width: window.innerWidth, height: window.innerHeight};
		clock = new THREE.Clock();		
		scene = new THREE.Scene();
		camera = new THREE.PerspectiveCamera(75, visibleSize.width / visibleSize.height, 0.1, 10000);
		camera2 = new THREE.PerspectiveCamera(75, visibleSize.width / visibleSize.height, 0.1, 10000);
		//camera.position.z = 2;
		
		camera2.position.z = 2;
		camera2.position.y = 5;
		//controls = new THREE.GamepadControls( camera );
		renderer = new THREE.WebGLRenderer( {precision: "mediump" } );
		renderer.setClearColor(new THREE.Color(0, 0, 0));
		renderer.setPixelRatio((visibleSize.width/2) / (visibleSize.height));
		renderer.setSize(visibleSize.width/2, visibleSize.height);

		renderer2 = new THREE.WebGLRenderer( {precision: "mediump" } );
		renderer2.setClearColor(new THREE.Color(0, 0, 0));
		renderer2.setPixelRatio((visibleSize.width/2) / (visibleSize.height));
		renderer2.setSize(visibleSize.width/2, visibleSize.height);


		var geometry = new THREE.SphereGeometry(1000, 60, 40);
		var material = new THREE.MeshBasicMaterial();
		material.map = THREE.ImageUtils.loadTexture("designAttack/Sky.jpg");
		material.side = THREE.BackSide;
		var skydome = new THREE.Mesh(geometry, material);

		scene.add(skydome);



		var ambientLight = new THREE.AmbientLight(new THREE.Color(1, 1, 1), 1.0);
		scene.add(ambientLight);

		/*var directionalLight = new THREE.DirectionalLight(new THREE.Color(1, 1, 1), 0.4);
		directionalLight.position.set(0, 0, 1);
		scene.add(directionalLight);*/

		var grid = new THREE.GridHelper(50, 10, 0xffffff, 0xffffff);
		grid.position.y = -1;
		scene.add(grid);

		$("#scene-section").append(renderer.domElement);
		$("#scene-section2").append(renderer2.domElement);
	}


	</script>
</head>

<body>
	
	<div class =".flex-container" style="display: flex; height: 100px;">

	<div style ="width: 49%; 	border: 2px solid yellow;" id="scene-section"/></div>
	<div  style ="width: 49%; 	border: 2px solid yellow;" id="scene-section2"/></div>
	<div>
		<h2 id="puntuacionJ1">puntuacion 1</h2>
		<h2 id="puntuacionJ2">puntuacion 2</h2>
		<h2 id="textoTiempo">Time</h2>

	</div>
	<div class="mPausa">
		<center>
			<img src="CSS/nombreJuego.png" alt="nombresito" style="height: 225px; width: 225px;">
		</center>
		<center>
			<h3 id="puntajeP1"></h3>
		</center>
		<center>
			<div id="botones">
				<button id="btnReanudar" class="btn btn-Retornar">Continuar jugando</button>
				<button id="BtnSalirMenu" class="btn btn-Menu">Volver al Menu</button>
			</div>
		</center>
    </div>
	<div class="imgWin">
		<center>
			<h3 id="win">Jugador tal, has ganado</h3>
			<h4 id="puntJ1">Puntuacion final</h4>
		</center>
		
		<center>
			<img src="CSS/botonOpciones.png" alt="nombresito" style="height: 150px; width: 150px;">
		</center>
	</div>
	<div class="imgLose">
		<center>
			<h3 id="lose">Jugador tal, has perdido</h3>
			<h4 id="puntJ2">Puntuacion final</h4>
		</center>
		<center>
			<img src="CSS/botonJugar.png" alt="nombresito" style="height: 150px; width: 150px;">
		</center>
	</div>
</div>
</body>
</html>